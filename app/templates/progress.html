{% extends "base.html" %}
{% block content %}
  <div class="row">
    <div class="col-lg-8 col-xl-6">
      <h1 class="mb-3">Analyzing transcripts</h1>
      <p class="text-muted">We're running the thematic analysis. This page will update with real-time progress and redirect when results are ready.</p>
      <div id="analysisStatus" class="alert alert-info d-flex align-items-center gap-2 mb-3" role="status" aria-live="polite">
        <div id="statusSpinner" class="spinner-border spinner-border-sm" role="presentation"></div>
        <span id="statusMessage">Starting analysis...</span>
      </div>
      <div class="card">
        <div class="card-header">Status</div>
        <div class="card-body" id="progressLog" style="max-height: 18rem; overflow-y: auto" aria-live="polite">
          <p class="mb-1">Starting analysis...</p>
        </div>
      </div>
    </div>
  </div>
  <script>
    const statusUrl = "{{ url_for('main.job_status', job_id=job_id) }}";
    const resultsUrl = "{{ url_for('main.results', job_id=job_id) }}";
    const statusContainer = document.getElementById('analysisStatus');
    const statusSpinner = document.getElementById('statusSpinner');
    const statusMessage = document.getElementById('statusMessage');
    const logContainer = document.getElementById('progressLog');
    let displayedEvents = 0;
    let polling = true;

    async function pollStatus() {
      if (!polling) {
        return;
      }
      try {
        const response = await fetch(statusUrl, {cache: 'no-store'});
        if (!response.ok) {
          throw new Error('Failed to fetch progress');
        }
        const payload = await response.json();
        updateProgress(payload);
        if (payload.status === 'completed') {
          polling = false;
          updateStatus('completed', 'Analysis complete. Redirecting to results...');
          window.location.href = resultsUrl;
          return;
        }
        if (payload.status === 'failed') {
          polling = false;
          updateStatus('failed', payload.message || 'Analysis failed.');
          if (payload.error && payload.error !== (payload.message || '')) {
            appendMessage(payload.error);
          }
          return;
        }
      } catch (error) {
        console.error(error);
        updateStatus('warning', 'Connection issue detected. Retrying...');
        appendMessage('Connection issue detected. Retrying...');
      }
      setTimeout(pollStatus, 1500);
    }

    function updateProgress(payload) {
      updateStatus(payload.status, payload.message);
      if (Array.isArray(payload.events)) {
        const newEvents = payload.events.slice(displayedEvents);
        newEvents.forEach(event => appendMessage(event.message));
        displayedEvents = payload.events.length;
      }
    }

    function updateStatus(status, message) {
      const normalized = status === 'failed'
        ? 'failed'
        : status === 'completed'
          ? 'completed'
          : status === 'warning'
            ? 'warning'
            : 'running';
      const fallback = normalized === 'failed'
        ? 'Analysis failed.'
        : normalized === 'completed'
          ? 'Analysis complete.'
          : normalized === 'warning'
            ? 'Connection issue detected. Retrying...'
            : 'Working on your analysis...';
      statusMessage.textContent = message || fallback;

      const classes = [
        'alert',
        'd-flex',
        'align-items-center',
        'gap-2',
        'mb-3',
      ];

      switch (normalized) {
        case 'failed':
          classes.push('alert-danger');
          statusSpinner.classList.add('d-none');
          break;
        case 'completed':
          classes.push('alert-success');
          statusSpinner.classList.add('d-none');
          break;
        case 'warning':
          classes.push('alert-warning');
          statusSpinner.classList.remove('d-none');
          break;
        default:
          classes.push('alert-info');
          statusSpinner.classList.remove('d-none');
      }

      statusContainer.className = classes.join(' ');
    }

    function appendMessage(message) {
      if (!message) {
        return;
      }
      const entry = document.createElement('p');
      entry.className = 'mb-1';
      entry.textContent = message;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    pollStatus();
  </script>
{% endblock %}
